Sub 按照指定字段拆分工作表()
    a = Time
    Call 排序
    Dim myRange As Variant
    Dim myArray
    Dim titleRange As Range
    Dim title As String
    Dim columnNum As Integer
    
    'myRange = Application.InputBox(prompt:="请用鼠标点击标题行：", Type:=8)
    myRange = Rows(1)
    myArray = WorksheetFunction.Transpose(myRange)
    'Set titleRange = Application.InputBox(prompt:="请用鼠标点击要拆分的字段，必须是第一行，且为1个单元格", Type:=8)
    Set titleRange = Cells(1, 5)
    '需要拆分的字段的名字，用于后续写SQL代码用
    title = titleRange.Value
    '目标数据总列数
    columnNum = titleRange.Column
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    Dim i&, Myr&, Arr, num&
    Dim d, k
    '删除其他sheet
    For i = Sheets.Count To 1 Step -1
        If Sheets(i).Name <> "数据源" Then
            Sheets(i).Delete
        End If
    Next i
    
    Debug.Print columnNum
    Set d = CreateObject("Scripting.Dictionary")
    Myr = Worksheets("数据源").UsedRange.Rows.Count
    Arr = Worksheets("数据源").Range(Cells(2, columnNum), Cells(Myr, columnNum))
    
    '''''''''''''''''
    '先拆分非分销SKU
    '''''''''''''''''
    '除标题外的目标数据，每一格赋值到字典中
    For i = 1 To UBound(Arr)
        If Worksheets("数据源").Cells(i + 1, 3).Value = "否" Then
            d(Arr(i, 1)) = ""
        End If
    Next
    '把字典d的key赋给k，k作为字典的keys有剔重作用，k(i)就是该数组的所有不重复值
    k = d.keys
    For i = 0 To UBound(k)
        '设置SQL连接
        Set Conn = CreateObject("adodb.connection")
        Select Case Application.Version * 1 '设置连接字符串,根据版本创建连接
            Case Is <= 11
                Conn.Open "Provider=Microsoft.Jet.Oledb.4.0;Extended Properties=excel 8.0;Data source=" & ThisWorkbook.FullName
            Case Is >= 12
                Conn.Open "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.FullName & ";Extended Properties=""Excel 12.0;HDR=YES"";"""
        End Select
        
        Sql = "select * from [数据源$] where " & title & " = '" & k(i) & "'"
        Sql = Sql & " and [数据源$].是否分销 = '否'"
        
        '在现有所有sheet之后增加一个sheet,after的用法
        Worksheets.Add after:=Sheets(Sheets.Count)
        
        With ActiveSheet
            '每个key，即每个产品代码作为sheet名字
            .Name = k(i)
            '首行标题赋值
            For num = 1 To UBound(myArray)
                .Cells(1, num) = myArray(num, 1)
            Next num
            '从第二行开始把SQL查询结果粘贴
            .Range("A2").CopyFromRecordset Conn.Execute(Sql)
        End With
        Call 转置粘贴
        Conn.Close
        Set Conn = Nothing
    Next i
    
    
    
    '''''''''''''''''
    '再拆分分销SKU
    '''''''''''''''''
    '设置SQL连接
    Set Conn = CreateObject("adodb.connection")
    Select Case Application.Version * 1 '设置连接字符串,根据版本创建连接
        Case Is <= 11
            Conn.Open "Provider=Microsoft.Jet.Oledb.4.0;Extended Properties=excel 8.0;Data source=" & ThisWorkbook.FullName
        Case Is >= 12
            Conn.Open "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.FullName & ";Extended Properties=""Excel 12.0;HDR=YES"";"""
    End Select
    
    Sql = "select * from [数据源$] where [数据源$].是否分销 = '是'"
    '在现有所有sheet之后增加一个sheet,after的用法
    Worksheets.Add after:=Sheets(Sheets.Count)
    
    With ActiveSheet
        '每个key，即每个产品代码作为sheet名字
        .Name = "OTTO分销"
        '首行标题赋值
        For num = 1 To UBound(myArray)
            .Cells(1, num) = myArray(num, 1)
        Next num
        '从第二行开始把SQL查询结果粘贴
        .Range("A2").CopyFromRecordset Conn.Execute(Sql)
    End With
    Call 转置粘贴
    Conn.Close
    Set Conn = Nothing
    
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    Dim b
    b = Time - a
    b = Round(b, 2)
    MsgBox " 已经拆分完成" & Chr(13) & "一共用时" & b & "秒"
    
End Sub
Sub 转置粘贴()
    Dim copy_content()
    copyRange = ActiveSheet.UsedRange
    copy_content = WorksheetFunction.Transpose(copyRange)
    ActiveSheet.UsedRange.ClearContents
    ActiveSheet.Range("A2").Resize(UBound(copy_content), UBound(copy_content, 2)) = copy_content
    ActiveSheet.Rows("2:4").Delete
    ActiveSheet.Range("B10:XFD28").NumberFormatLocal = "0.00%"
    For Each rn In ActiveSheet.Range("a2", "a28")
        rn.Interior.Color = RGB(172, 185, 202)
    Next
End Sub
Sub 排序()
    Dim oRead_Excel_Conn As Object
    Dim sExcel_Select As String
    Application.ScreenUpdating = False
    '设置SQL连接
    Set oRead_Excel_Conn = CreateObject("adodb.connection")
    Select Case Application.Version * 1 '设置连接字符串,根据版本创建连接
        Case Is <= 11
            oRead_Excel_Conn.Open "Provider=Microsoft.Jet.Oledb.4.0;Extended Properties=excel 8.0;Data source=" & ThisWorkbook.FullName
        Case Is >= 12
            oRead_Excel_Conn.Open "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.FullName & ";Extended Properties=""Excel 12.0;HDR=YES"";"""
    End Select
    sExcel_Select = "Select * From [数据源$] Order By [产品代码],[站点],[日期]"
    With Sheets("数据源")
        '.[A1].CurrentRegion.Offset(1).ClearContents
        .[A2].CopyFromRecordset oRead_Excel_Conn.Execute(sExcel_Select)
    End With
    oRead_Excel_Conn.Close
    Set oRead_Excel_Conn = Nothing
    Application.ScreenUpdating = True
End Sub
